<!DOCTYPE html>
<html lang="en-us">
    <head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<title>
		A Practical Guide to  State Machines &middot; Denis Kyashif&#39;s Blog
	</title>
	
	
  	<link rel="stylesheet" href="/css/style.css" />    
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
	<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/my.css">    
	
	<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
	
	
	<link href="" rel="alternate" type="application/rss+xml" title="Denis Kyashif&#39;s Blog" />
    <meta property="og:title" content="A Practical Guide to  State Machines" />
<meta property="og:description" content="Express complex application logic in an elegant and concise way using C#&rsquo;s pattern matching." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://deniskyashif.com/a-practical-guide-to-state-machines/" />

<meta property="og:image" content="https://deniskyashif.com/images/posts/2019-11-20-guide-to-fsm/smiling-fsm.png" />
<meta property="article:published_time" content="2019-11-20T07:28:47+02:00" />
<meta property="article:modified_time" content="2019-11-20T07:28:47+02:00" />

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-133185625-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head>

    <body>
        <a href="https://github.com/deniskyashif/blog" class="github-corner" target="_blank" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#211F1F; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

<nav class="nav">
	<div class="nav-container">
        <a href="/">
			<h2 class="nav-title">Denis Kyashif&#39;s Blog</h2>
		</a>
        <a class="rss" href="/index.xml" type="application/rss+xml" target="_blank" title="RSS Feed">
            <i class="fa fa-2x fa-rss" aria-hidden="true"></i>
        </a>
		<ul>
    <li><a href="/">Posts</a></li>
    <li><a href="/talks">Talks</a></li>
    <li><a href="/about">About</a></li>
</ul>

	</div>
</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <time datetime="2019-11-20 07:28:47 &#43;0200 EET">November 20, 2019</time>

    
    <div class="tags">
        
        
        
        <a href="https://deniskyashif.com/tags/state-machines/" class="tag">state-machines</a>
        
        
        
        
        <a href="https://deniskyashif.com/tags/software-design/" class="tag">software-design</a>
        
        
        
        
        <a href="https://deniskyashif.com/tags/csharp/" class="tag">csharp</a>
        
        
    </div>
</div>

		<h1 class="post-title">A Practical Guide to  State Machines</h1>
<div class="post-line"></div>

		

		

<p>In this article, we&rsquo;ll examine some examples of real-world problems that can be expressed and solved using finite state machines. We&rsquo;ll take the opportunity to explore some of the C#&rsquo;s pattern matching capabilities an see how they come handy for implementing them. In the second part, we&rsquo;ll see how to combine multiple state machines to form a cohesive workflow.</p>

<h2 id="an-informal-definition">An Informal Definition</h2>

<p>A finite state machine is an abstract device that has states and transitions between those states. It&rsquo;s always in one of its states and while it reads an input, it switches from state to state. Think of it as a directed graph. A state machine has no memory, that is, it does not keep track of the previous states it has been in. It only knows its current state. If there&rsquo;s no transition on a given input, the machine terminates.<br />
For a state machine to be deterministic means that on each input there is one and only one state to which it can transition from its current state. All of the examples in this article are of deterministic state machines.</p>

<p><svg width="800" height="170" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <ellipse stroke="black" stroke-width="1" fill="none" cx="218.5" cy="89.5" rx="30" ry="30"/>
    <text x="196.5" y="95.5" font-family="Times New Roman" font-size="20">Open</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="365.5" cy="89.5" rx="30" ry="30"/>
    <text x="337.5" y="95.5" font-family="Times New Roman" font-size="20">Closed</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="498.5" cy="89.5" rx="30" ry="30"/>
    <text x="468.5" y="95.5" font-family="Times New Roman" font-size="20">Locked</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 234.842,64.554 A 79.509,79.509 0 0 1 349.158,64.554"/>
    <polygon fill="black" stroke-width="1" points="349.158,64.554 347.192,55.327 340.003,62.278"/>
    <text x="271.5" y="31.5" font-family="Times New Roman" font-size="20">close</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 346.918,112.846 A 83.41,83.41 0 0 1 237.082,112.846"/>
    <polygon fill="black" stroke-width="1" points="237.082,112.846 239.811,121.877 246.395,114.35"/>
    <text x="272.5" y="154.5" font-family="Times New Roman" font-size="20">open</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 378.187,62.582 A 68.147,68.147 0 0 1 485.813,62.582"/>
    <polygon fill="black" stroke-width="1" points="485.813,62.582 484.853,53.197 476.956,59.332"/>
    <text x="414.5" y="27.5" font-family="Times New Roman" font-size="20">lock</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 483.841,115.409 A 69.595,69.595 0 0 1 380.159,115.409"/>
    <polygon fill="black" stroke-width="1" points="380.159,115.409 381.771,124.704 389.22,118.032"/>
    <text x="404.5" y="159.5" font-family="Times New Roman" font-size="20">unlock</text>
</svg>
<p class="text-center"><small>Figure 1: Representation of a door using a state machine</small></p></p>

<p>The state machine in Figure 1 has:</p>

<ul>
<li>a set of states: <code>Open</code>, <code>Closed</code>, <code>Locked</code></li>
<li>a set of inputs: <code>open</code>, <code>close</code>, <code>lock</code>, <code>unlock</code></li>
<li>a transition function of type: <code>State x Input -&gt; State</code></li>
</ul>

<p>Besides, state machines have an <strong>initial state</strong> (we can pick an arbitrary one in Figure 1) and a <strong>set of final states</strong> (which is empty in Figure 1).</p>

<h2 id="representing-state-machines-in-c">Representing State Machines in C#</h2>

<p>State machines are simply directed graphs and there&rsquo;re various ways to construct one. We can use an <a href="https://en.wikipedia.org/wiki/Adjacency_matrix">adjacency matrix</a>, or go with an object-oriented approach via <a href="https://en.wikipedia.org/wiki/State_pattern">the state pattern</a> or encode the state and the transitions in a map structure such as C#&rsquo;s <code>Dictionary&lt;TKey, TValue&gt;</code> where the keys are the states and their values are the sets of transitions from these states.</p>

<p>The recent developments in v. 8 of C# added significant improvements in its pattern matching capabilities and the <strong>switch expressions</strong> in particular  (which provided some inspiration for this article). If you haven&rsquo;t checked them out, I recommend <a href="https://devblogs.microsoft.com/dotnet/do-more-with-patterns-in-c-8-0/">this article</a> by Mads Torgersen.</p>

<p>We implement the state machine in Figure 1 as:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a2f;font-weight:bold">enum</span> State { Open, Closed, Locked }
<span style="color:#a2f;font-weight:bold">enum</span> Input { Open, Close, Lock, Unlock }

State ChangeState(State current, Input input) =&gt; 
    (current, action) <span style="color:#a2f;font-weight:bold">switch</span>
	{
        (State.Closed, Input.Open) =&gt; State.Open,
        (State.Open, Input.Close) =&gt; State.Closed,
        (State.Closed, Input.Lock) =&gt; State.Locked,
        (State.Locked, Input.Unlock) =&gt; State.Closed,
        _ =&gt; <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> NotSupportedException(
            <span style="color:#b44">$&#34;{current} has no transition on {input}&#34;</span>)
	};
</code></pre></div>
<p>That&rsquo;s how we &ldquo;run&rdquo; our machine:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#0b0;font-weight:bold">var</span> current = State.Closed; <span style="color:#080;font-style:italic">// the initial state
</span><span style="color:#080;font-style:italic"></span>current = ChangeState(current, Input.Open); <span style="color:#080;font-style:italic">// Opened
</span><span style="color:#080;font-style:italic"></span>current = ChangeState(current, Input.Close); <span style="color:#080;font-style:italic">// Closed
</span><span style="color:#080;font-style:italic"></span>current = ChangeState(current, Input.Lock); <span style="color:#080;font-style:italic">// Locked
</span><span style="color:#080;font-style:italic"></span>current = ChangeState(current, Input.Open); <span style="color:#080;font-style:italic">// throws
</span></code></pre></div>
<h2 id="state-machines-with-async-actions">State Machines with Async Actions</h2>

<p>Let&rsquo;s take a look at another example. This time we&rsquo;ll implement a process scheduler.</p>

<p><svg width="800" height="275" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <ellipse stroke="black" stroke-width="1" fill="none" cx="142.5" cy="42.5" rx="30" ry="30"/>
    <text x="114" y="48.5" font-family="Times New Roman" font-size="18">Created</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="228.5" cy="109.5" rx="30" ry="30"/>
    <text x="204.5" y="115.5" font-family="Times New Roman" font-size="18">Ready</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="451.5" cy="117.5" rx="30" ry="30"/>
    <text x="423" y="123.5" font-family="Times New Roman" font-size="16">Running</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="339.5" cy="226.5" rx="30" ry="30"/>
    <text x="310.5" y="232.5" font-family="Times New Roman" font-size="18">Waiting</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="559.5" cy="42.5" rx="40" ry="40"/>
    <text x="522.5" y="48.5" font-family="Times New Roman" font-size="16">Terminated</text>
    <polygon stroke="black" stroke-width="1" points="166.166,60.937 204.834,91.063"/>
    <polygon fill="black" stroke-width="1" points="204.834,91.063 201.596,82.202 195.451,90.09"/>
    <text x="134.5" y="96.5" font-family="Times New Roman" font-size="20">admit</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 249.315,87.979 A 137.456,137.456 0 0 1 432.28,94.543"/>
    <polygon fill="black" stroke-width="1" points="432.28,94.543 429.969,85.396 423.046,92.613"/>
    <text x="273.5" y="44.5" font-family="Times New Roman" font-size="20">schedule dispatch</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 426.252,133.634 A 175.265,175.265 0 0 1 252.527,127.402"/>
    <polygon fill="black" stroke-width="1" points="252.527,127.402 256.694,135.866 261.961,127.366"/>
    <text x="303.5" y="175.5" font-family="Times New Roman" font-size="20">interrupt</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 449.645,147.332 A 100.929,100.929 0 0 1 369.371,225.456"/>
    <polygon fill="black" stroke-width="1" points="369.371,225.456 378.15,228.911 376.324,219.079"/>
    <text x="426.5" y="219.5" font-family="Times New Roman" font-size="20">I/O or event wait</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 309.779,223.198 A 108.337,108.337 0 0 1 230.234,139.354"/>
    <polygon fill="black" stroke-width="1" points="230.234,139.354 226.892,148.176 236.7,146.224"/>
    <text x="77.5" y="213.5" font-family="Times New Roman" font-size="20">I/O or event complete</text>
    <polygon stroke="black" stroke-width="1" points="475.233,99.15 524.767,60.85"/>
    <polygon fill="black" stroke-width="1" points="524.767,60.85 515.38,61.788 521.496,69.699"/>
    <text x="464.5" y="71.5" font-family="Times New Roman" font-size="20">exit</text>
</svg>
<p class="text-center"><small>Figure 2: The states of a process</small></p></p>

<p>In Figure 2 we have the following sets of states and inputs:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a2f;font-weight:bold">enum</span> State { New, Ready, Running, Waiting, Terminated }
<span style="color:#a2f;font-weight:bold">enum</span> Input { 
    Admit, ScheduleDispatch, Interrupt,
    IOorEventWait, IOorEventComplete, Exit 
}
</code></pre></div>
<p>That&rsquo;s how we implement the transition function:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">State ChangeState(State current, Input input) =&gt;
    (current, input) <span style="color:#a2f;font-weight:bold">switch</span>
    {
        (State.Created, Input.Admit) =&gt; State.Ready,
        (State.Ready, Input.ScheduleDispatch) =&gt; State.Running,
        (State.Running, Input.IOorEventWait) =&gt; State.Waiting,
        (State.Waiting, Input.IOorEventComplete) =&gt; State.Ready,
        (State.Running, Input.Interrupt) =&gt; State.Ready,
        (State.Running, Input.Exit) =&gt; State.Terminated,
        _ =&gt; <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> NotSupportedException(
            <span style="color:#b44">$&#34;{current} has no transition on {input}&#34;</span>)
    };
</code></pre></div>
<p>We can also create conditional transitions using the <code>when</code> keyword.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">State ChangeState(State current, Input input, <span style="color:#0b0;font-weight:bold">bool</span> hasPermission) =&gt;
    (current, input) <span style="color:#a2f;font-weight:bold">switch</span>
    {
        (State.New, Input.Admit) when hasPermission =&gt; State.Ready
        <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    };
</code></pre></div>
<p>Suppose we want to execute some transition action on state change. Keep in mind that what comes after the <code>=&gt;</code> is an expression. So far we were simply returning values, now we want to run some arbitrary code. The approach might not seem very intuitive, but for those familiar with JavaScript it should ring a bell. We&rsquo;re going to wrap our code in an <em>immediately invoked function expression <a href="https://developer.mozilla.org/en-US/docs/Glossary/IIFE">(IIFE)</a></em> using C#&rsquo;s lambda syntax.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">State ChangeState(State current, Input input) =&gt;
    (current, input) <span style="color:#a2f;font-weight:bold">switch</span>
	{
        (State.New, Input.Admit) =&gt; ((Func&lt;State&gt;)(() =&gt; {
            ExecuteSomeAction();
            <span style="color:#a2f;font-weight:bold">return</span> State.Ready;
        }))(),
        <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    };
</code></pre></div>
<p>The usage of our <code>ChangeState</code> method remains the same.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#0b0;font-weight:bold">var</span> current = ChangeState(State.New, Input.Admit); <span style="color:#080;font-style:italic">// Ready
</span></code></pre></div>
<p>If <code>ExecuteSomeAction()</code> is a long-running operation, it would make sense to unblock the current thread by making it asynchronous. That requires us to refactor our state machine.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a2f;font-weight:bold">async</span> Task&lt;State&gt; ChangeState(State current, Input input) =&gt;
    (current, input) <span style="color:#a2f;font-weight:bold">switch</span>
    {
        (State.New, Input.Admit) =&gt; 
            <span style="color:#a2f;font-weight:bold">await</span> ((Func&lt;Task&lt;State&gt;&gt;)(<span style="color:#a2f;font-weight:bold">async</span> () =&gt; {
                <span style="color:#a2f;font-weight:bold">await</span> ExecuteSomeActionAsync();
                <span style="color:#a2f;font-weight:bold">return</span> State.Ready;
            }))(),
        (State.Ready, Input.ScheduleDispatch) =&gt; 
            <span style="color:#a2f;font-weight:bold">await</span> Task.FromResult(State.Running),
        <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>   	};
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#0b0;font-weight:bold">var</span> current = <span style="color:#a2f;font-weight:bold">await</span> ChangeState(State.New, Input.Admit); <span style="color:#080;font-style:italic">// Ready
</span></code></pre></div>
<h2 id="combining-state-machines">Combining State Machines</h2>

<p>In this example, we&rsquo;ll see how separate state machines can interact with each other to form a unified workflow.</p>

<p>We&rsquo;re given the task to design an online store where customers can purchase items by paying online through a bank. The system has three participants: the customer, the store and the bank, with the following requirements:</p>

<ul>
<li>The customer may <em>pay</em> or <em>cancel</em> at any given time.</li>
<li>The store may <em>ship</em> items to the customer.</li>
<li>The store may <em>redeem</em> the money from the bank.</li>
<li>The bank may <em>transfer</em> any redeemed money (e.g. to the store).</li>
</ul>

<p>We have to ensure that the customer cannot use one issued payment multiple times, or <em>pay</em> and immediately <em>cancel</em>, thus getting the items for free. The bank must ensure that money cannot be <em>canceled</em> and <em>redeemed</em> at the same time. The store should <em>ship</em> the items only when it gets the payment.</p>

<p>We model a separate state machine for each participant. Let&rsquo;s start with the bank.</p>

<p><svg width="800" height="200" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <ellipse stroke="black" stroke-width="1" fill="none" cx="242.5" cy="160.5" rx="30" ry="30"/>
    <text x="237.5" y="166.5" font-family="Times New Roman" font-size="20">1</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="242.5" cy="35.5" rx="30" ry="30"/>
    <text x="237.5" y="41.5" font-family="Times New Roman" font-size="20">2</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="384.5" cy="160.5" rx="30" ry="30"/>
    <text x="379.5" y="166.5" font-family="Times New Roman" font-size="20">3</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="525.5" cy="160.5" rx="30" ry="30"/>
    <text x="520.5" y="166.5" font-family="Times New Roman" font-size="20">4</text>
    <polygon stroke="black" stroke-width="1" points="242.5,130.5 242.5,65.5"/>
    <polygon fill="black" stroke-width="1" points="242.5,65.5 237.5,73.5 247.5,73.5"/>
    <text x="247.5" y="104.5" font-family="Times New Roman" font-size="20">cancel</text>
    <polygon stroke="black" stroke-width="1" points="272.5,160.5 354.5,160.5"/>
    <polygon fill="black" stroke-width="1" points="354.5,160.5 346.5,155.5 346.5,165.5"/>
    <text x="284.5" y="181.5" font-family="Times New Roman" font-size="20">redeem</text>
    <polygon stroke="black" stroke-width="1" points="414.5,160.5 495.5,160.5"/>
    <polygon fill="black" stroke-width="1" points="495.5,160.5 487.5,155.5 487.5,165.5"/>
    <text x="424.5" y="181.5" font-family="Times New Roman" font-size="20">transfer</text>
</svg>
<p class="text-center"><small>Figure 3.1: The Bank</small></p></p>

<p>The initial state <code>1</code> represents the situation when the bank has issued the money but has not been requested to either <em>redeem</em> it (by the store) or <em>cancel</em> it (by the customer). Once the store <em>redeems</em> the money, the bank enters state <code>3</code> and thus can to <em>transfer</em> it to the store&rsquo;s account. When it&rsquo;s in state <code>2</code>, it restores the money to the customer&rsquo;s account. The fact that we don&rsquo;t allow the bank to leave state <code>2</code> prevents restoring the customer&rsquo;s money multiple times.</p>

<p><svg width="800" height="200" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <ellipse stroke="black" stroke-width="1" fill="none" cx="125.5" cy="41.5" rx="30" ry="30"/>
    <text x="121.5" y="47.5" font-family="Times New Roman" font-size="20">a</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="258.5" cy="41.5" rx="30" ry="30"/>
    <text x="253.5" y="47.5" font-family="Times New Roman" font-size="20">b</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="258.5" cy="164.5" rx="30" ry="30"/>
    <text x="254.5" y="170.5" font-family="Times New Roman" font-size="20">c</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="402.5" cy="41.5" rx="30" ry="30"/>
    <text x="397.5" y="47.5" font-family="Times New Roman" font-size="20">d</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="402.5" cy="164.5" rx="30" ry="30"/>
    <text x="398.5" y="170.5" font-family="Times New Roman" font-size="20">e</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="551.5" cy="41.5" rx="30" ry="30"/>
    <text x="548.5" y="47.5" font-family="Times New Roman" font-size="20">f</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="551.5" cy="164.5" rx="30" ry="30"/>
    <text x="546.5" y="170.5" font-family="Times New Roman" font-size="20">g</text>
    <polygon stroke="black" stroke-width="1" points="155.5,41.5 228.5,41.5"/>
    <polygon fill="black" stroke-width="1" points="228.5,41.5 220.5,36.5 220.5,46.5"/>
    <text x="177.5" y="32.5" font-family="Times New Roman" font-size="20">pay</text>
    <polygon stroke="black" stroke-width="1" points="288.5,41.5 372.5,41.5"/>
    <polygon fill="black" stroke-width="1" points="372.5,41.5 364.5,36.5 364.5,46.5"/>
    <text x="301.5" y="32.5" font-family="Times New Roman" font-size="20">redeem</text>
    <polygon stroke="black" stroke-width="1" points="432.5,41.5 521.5,41.5"/>
    <polygon fill="black" stroke-width="1" points="521.5,41.5 513.5,36.5 513.5,46.5"/>
    <text x="446.5" y="32.5" font-family="Times New Roman" font-size="20">transfer</text>
    <polygon stroke="black" stroke-width="1" points="551.5,71.5 551.5,134.5"/>
    <polygon fill="black" stroke-width="1" points="551.5,134.5 556.5,126.5 546.5,126.5"/>
    <text x="556.5" y="109.5" font-family="Times New Roman" font-size="20">ship</text>
    <polygon stroke="black" stroke-width="1" points="402.5,71.5 402.5,134.5"/>
    <polygon fill="black" stroke-width="1" points="402.5,134.5 407.5,126.5 397.5,126.5"/>
    <text x="407.5" y="109.5" font-family="Times New Roman" font-size="20">ship</text>
    <polygon stroke="black" stroke-width="1" points="258.5,71.5 258.5,134.5"/>
    <polygon fill="black" stroke-width="1" points="258.5,134.5 263.5,126.5 253.5,126.5"/>
    <text x="263.5" y="109.5" font-family="Times New Roman" font-size="20">ship</text>
    <polygon stroke="black" stroke-width="1" points="288.5,164.5 372.5,164.5"/>
    <polygon fill="black" stroke-width="1" points="372.5,164.5 364.5,159.5 364.5,169.5"/>
    <text x="301.5" y="185.5" font-family="Times New Roman" font-size="20">redeem</text>
    <polygon stroke="black" stroke-width="1" points="432.5,164.5 521.5,164.5"/>
    <polygon fill="black" stroke-width="1" points="521.5,164.5 513.5,159.5 513.5,169.5"/>
    <text x="446.5" y="185.5" font-family="Times New Roman" font-size="20">transfer</text>
</svg>
<p class="text-center"><small>Figure 3.2: The Store</small></p></p>

<p>When the <em>pay</em> action is performed (by the customer), the store enters state <code>b</code>. It can then either <em>ship</em> the items or <em>redeem</em> the money from the bank. It can also ship when it has made a <em>redeem</em> request and before the money is <em>transferred</em>, or at the end when the money is <em>transferred</em> by the bank.</p>

<p><svg width="800" height="80" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <ellipse stroke="black" stroke-width="1" fill="none" cx="268.5" cy="48.5" rx="30" ry="30"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 295.297,35.275 A 22.5,22.5 0 1 1 295.297,61.725"/>
    <text x="341.5" y="54.5" font-family="Times New Roman" font-size="20">pay, cancel</text>
    <polygon fill="black" stroke-width="1" points="295.297,61.725 298.83,70.473 304.708,62.382"/>
</svg>
<p class="text-center"><small>Figure 3.3: The Customer</small></p></p>

<p>The customer&rsquo;s state machine has only one state and two input actions that lead back to the same state. This means that the customer <strong>can do anything</strong> any number of times.</p>

<h3 id="dealing-with-the-missing-action-inputs">Dealing with the Missing Action Inputs</h3>

<p>To combine these state machines, they should be able to process action inputs &ldquo;in parallel&rdquo;. We observe that some transitions are missing on some of the machines. For example, the store doesn&rsquo;t have a notion of the <em>cancel</em> action. For the bank, <em>pay</em> and <em>ship</em> are irrelevant. To make the store &ldquo;ignore&rdquo; the <em>cancel</em> action, we simply have to add a transition from each of its states to itself on <em>cancel</em>.
Another potential problem would be when the customer executes <em>pay</em> for a second time, while the store is in state <code>e</code>. We need to add a transition on <code>e</code> to itself on <em>pay</em>.</p>

<p><svg width="800" height="260" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <text x="100" y="230" text-decoration="underline" font-weight="bold" font-family="Times New Roman" font-size="20">The Bank</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="242.5" cy="160.5" rx="30" ry="30"/>
    <text x="237.5" y="166.5" font-family="Times New Roman" font-size="20">1</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="242.5" cy="33.5" rx="30" ry="30"/>
    <text x="237.5" y="39.5" font-family="Times New Roman" font-size="20">2</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="384.5" cy="160.5" rx="30" ry="30"/>
    <text x="379.5" y="166.5" font-family="Times New Roman" font-size="20">3</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="525.5" cy="160.5" rx="30" ry="30"/>
    <text x="520.5" y="166.5" font-family="Times New Roman" font-size="20">4</text>
    <polygon stroke="black" stroke-width="1" points="242.5,130.5 242.5,63.5"/>
    <polygon fill="black" stroke-width="1" points="242.5,63.5 237.5,71.5 247.5,71.5"/>
    <text x="186.5" y="103.5" font-family="Times New Roman" font-size="20">cancel</text>
    <polygon stroke="black" stroke-width="1" points="272.5,160.5 354.5,160.5"/>
    <polygon fill="black" stroke-width="1" points="354.5,160.5 346.5,155.5 346.5,165.5"/>
    <text x="284.5" y="181.5" font-family="Times New Roman" font-size="20">redeem</text>
    <polygon stroke="black" stroke-width="1" points="414.5,160.5 495.5,160.5"/>
    <polygon fill="black" stroke-width="1" points="495.5,160.5 487.5,155.5 487.5,165.5"/>
    <text x="424.5" y="181.5" font-family="Times New Roman" font-size="20">transfer</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 215.703,173.725 A 22.5,22.5 0 1 1 215.703,147.275"/>
    <text x="99.5" y="166.5" font-family="Times New Roman" font-size="20">pay, ship</text>
    <polygon fill="black" stroke-width="1" points="215.703,147.275 212.17,138.527 206.292,146.618"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 217.469,49.824 A 22.5,22.5 0 1 1 214.318,23.562"/>
    <text x="97.5" y="48.5" font-family="Times New Roman" font-size="20">pay, ship</text>
    <polygon fill="black" stroke-width="1" points="214.318,23.562 209.768,15.298 204.896,24.031"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 371.275,133.703 A 22.5,22.5 0 1 1 397.725,133.703"/>
    <text x="284.5" y="84.5" font-family="Times New Roman" font-size="20">pay, redeem, cancel, ship</text>
    <polygon fill="black" stroke-width="1" points="397.725,133.703 406.473,130.17 398.382,124.292"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 538.725,187.297 A 22.5,22.5 0 1 1 512.275,187.297"/>
    <text x="425.5" y="249.5" font-family="Times New Roman" font-size="20">pay, redeem, cancel, ship</text>
    <polygon fill="black" stroke-width="1" points="512.275,187.297 503.527,190.83 511.618,196.708"/>
</svg></p>

<p><svg width="800" height="320" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <text x="100" y="210" text-decoration="underline" font-weight="bold" font-family="Times New Roman" font-size="20">The Store</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="125.5" cy="112.5" rx="30" ry="30"/>
    <text x="121.5" y="118.5" font-family="Times New Roman" font-size="20">a</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="258.5" cy="112.5" rx="30" ry="30"/>
    <text x="253.5" y="118.5" font-family="Times New Roman" font-size="20">b</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="258.5" cy="224.5" rx="30" ry="30"/>
    <text x="254.5" y="230.5" font-family="Times New Roman" font-size="20">c</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="402.5" cy="112.5" rx="30" ry="30"/>
    <text x="397.5" y="118.5" font-family="Times New Roman" font-size="20">d</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="402.5" cy="224.5" rx="30" ry="30"/>
    <text x="398.5" y="230.5" font-family="Times New Roman" font-size="20">e</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="551.5" cy="112.5" rx="30" ry="30"/>
    <text x="548.5" y="118.5" font-family="Times New Roman" font-size="20">f</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="551.5" cy="224.5" rx="30" ry="30"/>
    <text x="546.5" y="230.5" font-family="Times New Roman" font-size="20">g</text>
    <polygon stroke="black" stroke-width="1" points="155.5,112.5 228.5,112.5"/>
    <polygon fill="black" stroke-width="1" points="228.5,112.5 220.5,107.5 220.5,117.5"/>
    <text x="177.5" y="103.5" font-family="Times New Roman" font-size="20">pay</text>
    <polygon stroke="black" stroke-width="1" points="288.5,112.5 372.5,112.5"/>
    <polygon fill="black" stroke-width="1" points="372.5,112.5 364.5,107.5 364.5,117.5"/>
    <text x="301.5" y="103.5" font-family="Times New Roman" font-size="20">redeem</text>
    <polygon stroke="black" stroke-width="1" points="432.5,112.5 521.5,112.5"/>
    <polygon fill="black" stroke-width="1" points="521.5,112.5 513.5,107.5 513.5,117.5"/>
    <text x="446.5" y="103.5" font-family="Times New Roman" font-size="20">transfer</text>
    <polygon stroke="black" stroke-width="1" points="551.5,142.5 551.5,194.5"/>
    <polygon fill="black" stroke-width="1" points="551.5,194.5 556.5,186.5 546.5,186.5"/>
    <text x="556.5" y="174.5" font-family="Times New Roman" font-size="20">ship</text>
    <polygon stroke="black" stroke-width="1" points="402.5,142.5 402.5,194.5"/>
    <polygon fill="black" stroke-width="1" points="402.5,194.5 407.5,186.5 397.5,186.5"/>
    <text x="407.5" y="174.5" font-family="Times New Roman" font-size="20">ship</text>
    <polygon stroke="black" stroke-width="1" points="258.5,142.5 258.5,194.5"/>
    <polygon fill="black" stroke-width="1" points="258.5,194.5 263.5,186.5 253.5,186.5"/>
    <text x="263.5" y="174.5" font-family="Times New Roman" font-size="20">ship</text>
    <polygon stroke="black" stroke-width="1" points="288.5,224.5 372.5,224.5"/>
    <polygon fill="black" stroke-width="1" points="372.5,224.5 364.5,219.5 364.5,229.5"/>
    <text x="301.5" y="245.5" font-family="Times New Roman" font-size="20">redeem</text>
    <polygon stroke="black" stroke-width="1" points="432.5,224.5 521.5,224.5"/>
    <polygon fill="black" stroke-width="1" points="521.5,224.5 513.5,219.5 513.5,229.5"/>
    <text x="446.5" y="245.5" font-family="Times New Roman" font-size="20">transfer</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 112.275,85.703 A 22.5,22.5 0 1 1 138.725,85.703"/>
    <text x="99.5" y="36.5" font-family="Times New Roman" font-size="20">cancel</text>
    <polygon fill="black" stroke-width="1" points="138.725,85.703 147.473,82.17 139.382,76.292"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 245.275,85.703 A 22.5,22.5 0 1 1 271.725,85.703"/>
    <text x="214.5" y="35.5" font-family="Times New Roman" font-size="20">pay, cancel</text>
    <polygon fill="black" stroke-width="1" points="271.725,85.703 280.473,82.17 272.382,76.292"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 389.275,85.703 A 22.5,22.5 0 1 1 415.725,85.703"/>
    <text x="358.5" y="35.5" font-family="Times New Roman" font-size="20">pay, cancel</text>
    <polygon fill="black" stroke-width="1" points="415.725,85.703 424.473,82.17 416.382,76.292"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 538.275,85.703 A 22.5,22.5 0 1 1 564.725,85.703"/>
    <text x="507.5" y="35.5" font-family="Times New Roman" font-size="20">pay, cancel</text>
    <polygon fill="black" stroke-width="1" points="564.725,85.703 573.473,82.17 565.382,76.292"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 271.725,251.297 A 22.5,22.5 0 1 1 245.275,251.297"/>
    <text x="214.5" y="313.5" font-family="Times New Roman" font-size="20">pay, cancel</text>
    <polygon fill="black" stroke-width="1" points="245.275,251.297 236.527,254.83 244.618,260.708"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 415.725,251.297 A 22.5,22.5 0 1 1 389.275,251.297"/>
    <text x="358.5" y="313.5" font-family="Times New Roman" font-size="20">pay, cancel</text>
    <polygon fill="black" stroke-width="1" points="389.275,251.297 380.527,254.83 388.618,260.708"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 564.725,251.297 A 22.5,22.5 0 1 1 538.275,251.297"/>
    <text x="507.5" y="313.5" font-family="Times New Roman" font-size="20">pay, cancel</text>
    <polygon fill="black" stroke-width="1" points="538.275,251.297 529.527,254.83 537.618,260.708"/>
</svg></p>

<p><svg width="800" height="105" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <text x="100" y="100" text-decoration="underline" font-weight="bold" font-family="Times New Roman" font-size="20">The Customer</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="170.5" cy="44.5" rx="30" ry="30"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 197.297,31.275 A 22.5,22.5 0 1 1 197.297,57.725"/>
    <text x="243.5" y="50.5" font-family="Times New Roman" font-size="20">pay, cancel, ship, redeem, transfer</text>
    <polygon fill="black" stroke-width="1" points="197.297,57.725 200.83,66.473 206.708,58.382"/>
</svg>
<p class="text-center"><small>Figure 3.4: The complete sets of transitions for the bank, the store and the customer</small></p></p>

<p>We added self-transitions to each of the participants&rsquo; states for the actions that:</p>

<ul>
<li>are irrelevant to the participant (e.g. <em>cancel</em> to the store).</li>
<li>can potentially &ldquo;terminate&rdquo; the machine (e.g. executing <em>pay</em> while the store is in a state other than <code>a</code>)</li>
</ul>

<p>Keep in mind that the behavior of the state machines does not depend on who initiates the action.</p>

<h3 id="constructing-the-product">Constructing the Product</h3>

<p>It&rsquo;s still not quite obvious how the states in the store and the bank interact. To see this more clearly, we need to construct <strong>the product</strong> of those state machines. The product is a state machine itself, and since the customer automaton only has one state, the states of the product are <strong>pairs of states from the bank and from the store</strong>.
For example, the state <code>(3,d)</code> represents the situation where the bank is in state <code>3</code> and the store is in state <code>d</code>. The total amount of states is 4x7=28. We group them in a table where the row corresponds to the state of the bank and the column to the state of the store. The initial state is the pair, both items of which are initial states of their respective machines - in our case <code>(1,a)</code>.</p>

<p><svg width="800" height="600" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <ellipse stroke="black" stroke-width="1" fill="#e8f7e4" cx="46.5" cy="91.5" rx="30" ry="30"/>
    <text x="32.5" y="97.5" font-family="Times New Roman" font-size="20">1, a</text>
    <ellipse stroke="black" stroke-width="1" fill="#e8f7e4" cx="160.5" cy="91.5" rx="30" ry="30"/>
    <text x="145.5" y="97.5" font-family="Times New Roman" font-size="20">1, b</text>
    <ellipse stroke="black" stroke-width="1" fill="#e8f7e4" cx="274.5" cy="91.5" rx="30" ry="30"/>
    <text x="260.5" y="97.5" font-family="Times New Roman" font-size="20">1, c</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="389.5" cy="91.5" rx="30" ry="30"/>
    <text x="374.5" y="97.5" font-family="Times New Roman" font-size="20">1, d</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="509.5" cy="91.5" rx="30" ry="30"/>
    <text x="495.5" y="97.5" font-family="Times New Roman" font-size="20">1, e</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="627.5" cy="91.5" rx="30" ry="30"/>
    <text x="614.5" y="97.5" font-family="Times New Roman" font-size="20">1, f</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="736.5" cy="91.5" rx="30" ry="30"/>
    <text x="721.5" y="97.5" font-family="Times New Roman" font-size="20">1, g</text>
    <ellipse stroke="black" stroke-width="1" fill="#e8f7e4" cx="46.5" cy="229.5" rx="30" ry="30"/>
    <text x="32.5" y="235.5" font-family="Times New Roman" font-size="20">2, a</text>
    <ellipse stroke="black" stroke-width="1" fill="#e8f7e4" cx="160.5" cy="229.5" rx="30" ry="30"/>
    <text x="145.5" y="235.5" font-family="Times New Roman" font-size="20">2, b</text>
    <ellipse stroke="black" stroke-width="1" fill="#e8f7e4" cx="274.5" cy="229.5" rx="30" ry="30"/>
    <text x="260.5" y="235.5" font-family="Times New Roman" font-size="20">2, c</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="389.5" cy="229.5" rx="30" ry="30"/>
    <text x="374.5" y="235.5" font-family="Times New Roman" font-size="20">2, d</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="509.5" cy="229.5" rx="30" ry="30"/>
    <text x="495.5" y="235.5" font-family="Times New Roman" font-size="20">2, e</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="627.5" cy="229.5" rx="30" ry="30"/>
    <text x="614.5" y="235.5" font-family="Times New Roman" font-size="20">2, f</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="736.5" cy="229.5" rx="30" ry="30"/>
    <text x="721.5" y="235.5" font-family="Times New Roman" font-size="20">2, g</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="46.5" cy="361.5" rx="30" ry="30"/>
    <text x="32.5" y="367.5" font-family="Times New Roman" font-size="20">3, a</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="169.5" cy="361.5" rx="30" ry="30"/>
    <text x="154.5" y="367.5" font-family="Times New Roman" font-size="20">3, b</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="281.5" cy="361.5" rx="30" ry="30"/>
    <text x="267.5" y="367.5" font-family="Times New Roman" font-size="20">3, c</text>
    <ellipse stroke="black" stroke-width="1" fill="#e8f7e4" cx="389.5" cy="361.5" rx="30" ry="30"/>
    <text x="374.5" y="367.5" font-family="Times New Roman" font-size="20">3, d</text>
    <ellipse stroke="black" stroke-width="1" fill="#e8f7e4" cx="509.5" cy="361.5" rx="30" ry="30"/>
    <text x="495.5" y="367.5" font-family="Times New Roman" font-size="20">3, e</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="627.5" cy="361.5" rx="30" ry="30"/>
    <text x="614.5" y="367.5" font-family="Times New Roman" font-size="20">3, f</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="736.5" cy="361.5" rx="30" ry="30"/>
    <text x="721.5" y="367.5" font-family="Times New Roman" font-size="20">3, g</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="46.5" cy="507.5" rx="30" ry="30"/>
    <text x="32.5" y="513.5" font-family="Times New Roman" font-size="20">4, a</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="169.5" cy="507.5" rx="30" ry="30"/>
    <text x="154.5" y="513.5" font-family="Times New Roman" font-size="20">4, b</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="281.5" cy="507.5" rx="30" ry="30"/>
    <text x="267.5" y="513.5" font-family="Times New Roman" font-size="20">4, c</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="389.5" cy="507.5" rx="30" ry="30"/>
    <text x="374.5" y="513.5" font-family="Times New Roman" font-size="20">4, d</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="509.5" cy="507.5" rx="30" ry="30"/>
    <text x="495.5" y="513.5" font-family="Times New Roman" font-size="20">4, e</text>
    <ellipse stroke="black" stroke-width="1" fill="#e8f7e4" cx="633.5" cy="507.5" rx="30" ry="30"/>
    <text x="620.5" y="513.5" font-family="Times New Roman" font-size="20">4, f</text>
    <ellipse stroke="black" stroke-width="1" fill="#e8f7e4" cx="736.5" cy="507.5" rx="30" ry="30"/>
    <text x="721.5" y="513.5" font-family="Times New Roman" font-size="20">4, g</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 715.525,70.215 A 22.5,22.5 0 1 1 740.636,61.905"/>
    <text x="700.5" y="18.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="740.636,61.905 747.83,55.802 738.303,52.764"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 69.756,526.266 A 22.5,22.5 0 1 1 45.75,537.374"/>
    <text x="79.5" y="589.5" font-family="Times New Roman" font-size="20">C</text>
    <polygon fill="black" stroke-width="1" points="45.75,537.374 39.295,544.253 49.106,546.191"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 361.659,350.35 A 350.621,350.621 0 0 1 166.956,120.788"/>
    <polygon fill="black" stroke-width="1" points="361.659,350.35 356.422,342.503 352.311,351.619"/>
    <text x="219.5" y="277.5" font-family="Times New Roman" font-size="20">R</text>
    <polygon stroke="black" stroke-width="1" points="76.5,91.5 130.5,91.5"/>
    <polygon fill="black" stroke-width="1" points="130.5,91.5 122.5,86.5 122.5,96.5"/>
    <text x="97.5" y="82.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon stroke="black" stroke-width="1" points="46.5,121.5 46.5,199.5"/>
    <polygon fill="black" stroke-width="1" points="46.5,199.5 51.5,191.5 41.5,191.5"/>
    <text x="28.5" y="166.5" font-family="Times New Roman" font-size="20">C</text>
    <polygon stroke="black" stroke-width="1" points="160.5,121.5 160.5,199.5"/>
    <polygon fill="black" stroke-width="1" points="160.5,199.5 165.5,191.5 155.5,191.5"/>
    <text x="142.5" y="166.5" font-family="Times New Roman" font-size="20">C</text>
    <polygon stroke="black" stroke-width="1" points="76.5,229.5 130.5,229.5"/>
    <polygon fill="black" stroke-width="1" points="130.5,229.5 122.5,224.5 122.5,234.5"/>
    <text x="97.5" y="220.5" font-family="Times New Roman" font-size="20">P</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 180.588,251.624 A 22.5,22.5 0 1 1 155.158,258.902"/>
    <text x="182.5" y="315.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="155.158,258.902 147.721,264.705 157.116,268.13"/>
    <polygon stroke="black" stroke-width="1" points="190.5,229.5 244.5,229.5"/>
    <polygon fill="black" stroke-width="1" points="244.5,229.5 236.5,224.5 236.5,234.5"/>
    <text x="211.5" y="220.5" font-family="Times New Roman" font-size="20">S</text>
    <polygon stroke="black" stroke-width="1" points="190.5,91.5 244.5,91.5"/>
    <polygon fill="black" stroke-width="1" points="244.5,91.5 236.5,86.5 236.5,96.5"/>
    <text x="211.5" y="82.5" font-family="Times New Roman" font-size="20">S</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 140.11,69.654 A 22.5,22.5 0 1 1 165.437,62.028"/>
    <text x="126.5" y="17.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="165.437,62.028 172.794,56.122 163.353,52.827"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 253.39,70.35 A 22.5,22.5 0 1 1 278.447,61.879"/>
    <text x="237.5" y="18.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="278.447,61.879 285.602,55.73 276.056,52.753"/>
    <polygon stroke="black" stroke-width="1" points="274.5,121.5 274.5,199.5"/>
    <polygon fill="black" stroke-width="1" points="274.5,199.5 279.5,191.5 269.5,191.5"/>
    <text x="256.5" y="166.5" font-family="Times New Roman" font-size="20">C</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 296.812,249.379 A 22.5,22.5 0 1 1 272.293,259.301"/>
    <text x="304.5" y="313.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="272.293,259.301 265.51,265.858 275.214,268.272"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 481.364,351.116 A 345.542,345.542 0 0 1 280.903,120.799"/>
    <polygon fill="black" stroke-width="1" points="481.364,351.116 475.92,343.412 472.053,352.634"/>
    <text x="335.5" y="279.5" font-family="Times New Roman" font-size="20">R</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 368.167,70.574 A 22.5,22.5 0 1 1 393.133,61.839"/>
    <text x="352.5" y="18.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="393.133,61.839 400.223,55.615 390.645,52.739"/>
    <polygon stroke="black" stroke-width="1" points="389.5,121.5 389.5,199.5"/>
    <polygon fill="black" stroke-width="1" points="389.5,199.5 394.5,191.5 384.5,191.5"/>
    <text x="371.5" y="166.5" font-family="Times New Roman" font-size="20">C</text>
    <polygon stroke="black" stroke-width="1" points="419.5,91.5 479.5,91.5"/>
    <polygon fill="black" stroke-width="1" points="479.5,91.5 471.5,86.5 471.5,96.5"/>
    <text x="443.5" y="82.5" font-family="Times New Roman" font-size="20">S</text>
    <polygon stroke="black" stroke-width="1" points="509.5,121.5 509.5,199.5"/>
    <polygon fill="black" stroke-width="1" points="509.5,199.5 514.5,191.5 504.5,191.5"/>
    <text x="491.5" y="166.5" font-family="Times New Roman" font-size="20">C</text>
    <polygon stroke="black" stroke-width="1" points="419.5,229.5 479.5,229.5"/>
    <polygon fill="black" stroke-width="1" points="479.5,229.5 471.5,224.5 471.5,234.5"/>
    <text x="443.5" y="220.5" font-family="Times New Roman" font-size="20">S</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 487.884,70.866 A 22.5,22.5 0 1 1 512.73,61.792"/>
    <text x="470.5" y="18.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="512.73,61.792 519.734,55.472 510.118,52.727"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 414.474,245.91 A 22.5,22.5 0 1 1 391.666,259.304"/>
    <text x="428.5" y="308.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="391.666,259.304 385.913,266.781 395.865,267.752"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 532.594,248.465 A 22.5,22.5 0 1 1 508.494,259.366"/>
    <text x="542.5" y="312.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="508.494,259.366 501.98,266.19 511.774,268.212"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 606.457,70.283 A 22.5,22.5 0 1 1 631.541,61.891"/>
    <text x="591.5" y="18.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="631.541,61.891 638.715,55.766 629.178,52.758"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 649.796,249.397 A 22.5,22.5 0 1 1 625.269,259.3"/>
    <text x="657.5" y="313.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="625.269,259.3 618.481,265.851 628.183,268.272"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 759.398,248.701 A 22.5,22.5 0 1 1 735.188,259.354"/>
    <text x="768.5" y="312.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="735.188,259.354 728.604,266.111 738.377,268.233"/>
    <polygon stroke="black" stroke-width="1" points="627.5,121.5 627.5,199.5"/>
    <polygon fill="black" stroke-width="1" points="627.5,199.5 632.5,191.5 622.5,191.5"/>
    <text x="609.5" y="166.5" font-family="Times New Roman" font-size="20">C</text>
    <polygon stroke="black" stroke-width="1" points="736.5,121.5 736.5,199.5"/>
    <polygon fill="black" stroke-width="1" points="736.5,199.5 741.5,191.5 731.5,191.5"/>
    <text x="718.5" y="166.5" font-family="Times New Roman" font-size="20">C</text>
    <polygon stroke="black" stroke-width="1" points="657.5,91.5 706.5,91.5"/>
    <polygon fill="black" stroke-width="1" points="706.5,91.5 698.5,86.5 698.5,96.5"/>
    <text x="676.5" y="82.5" font-family="Times New Roman" font-size="20">S</text>
    <polygon stroke="black" stroke-width="1" points="657.5,229.5 706.5,229.5"/>
    <polygon fill="black" stroke-width="1" points="706.5,229.5 698.5,224.5 698.5,234.5"/>
    <text x="676.5" y="220.5" font-family="Times New Roman" font-size="20">S</text>
    <polygon stroke="black" stroke-width="1" points="76.5,361.5 139.5,361.5"/>
    <polygon fill="black" stroke-width="1" points="139.5,361.5 131.5,356.5 131.5,366.5"/>
    <text x="102.5" y="352.5" font-family="Times New Roman" font-size="20">P</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 68.463,381.763 A 22.5,22.5 0 1 1 43.776,391.259"/>
    <text x="75.5" y="445.5" font-family="Times New Roman" font-size="20">C</text>
    <polygon fill="black" stroke-width="1" points="43.776,391.259 36.88,397.696 46.541,400.278"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 189.625,383.591 A 22.5,22.5 0 1 1 164.207,390.91"/>
    <text x="189.5" y="448.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="164.207,390.91 156.779,396.726 166.18,400.136"/>
    <polygon stroke="black" stroke-width="1" points="199.5,361.5 251.5,361.5"/>
    <polygon fill="black" stroke-width="1" points="251.5,361.5 243.5,356.5 243.5,366.5"/>
    <text x="219.5" y="352.5" font-family="Times New Roman" font-size="20">S</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 195.596,346.76 A 197.701,197.701 0 0 1 363.404,346.76"/>
    <polygon fill="black" stroke-width="1" points="363.404,346.76 358.282,338.837 354.038,347.892"/>
    <text x="272.5" y="319.5" font-family="Times New Roman" font-size="20">R</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 301.136,384.026 A 22.5,22.5 0 1 1 275.564,390.788"/>
    <text x="298.5" y="449.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="275.564,390.788 268.011,396.439 277.335,400.054"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 491.494,385.415 A 132.279,132.279 0 0 1 299.506,385.415"/>
    <polygon fill="black" stroke-width="1" points="491.494,385.415 482.362,387.781 489.619,394.661"/>
    <text x="388.5" y="447.5" font-family="Times New Roman" font-size="20">R</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 412.958,380.012 A 22.5,22.5 0 1 1 389.075,391.38"/>
    <text x="423.5" y="443.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="389.075,391.38 382.695,398.33 392.526,400.16"/>
    <polygon stroke="black" stroke-width="1" points="419.5,361.5 479.5,361.5"/>
    <polygon fill="black" stroke-width="1" points="479.5,361.5 471.5,356.5 471.5,366.5"/>
    <text x="443.5" y="352.5" font-family="Times New Roman" font-size="20">S</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 488.111,340.632 A 22.5,22.5 0 1 1 513.053,331.829"/>
    <text x="451.5" y="288.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="513.053,331.829 520.126,325.586 510.541,322.736"/>
    <polygon stroke="black" stroke-width="1" points="415.243,376.904 607.757,492.096"/>
    <polygon fill="black" stroke-width="1" points="607.757,492.096 603.459,483.698 598.324,492.279"/>
    <text x="516.5" y="425.5" font-family="Times New Roman" font-size="20">T</text>
    <polygon stroke="black" stroke-width="1" points="534.732,377.728 711.268,491.272"/>
    <polygon fill="black" stroke-width="1" points="711.268,491.272 707.245,482.739 701.835,491.149"/>
    <text x="628.5" y="425.5" font-family="Times New Roman" font-size="20">T</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 606.235,340.505 A 22.5,22.5 0 1 1 631.229,331.851"/>
    <text x="570.5" y="288.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="631.229,331.851 638.339,325.65 628.771,322.743"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 715.007,340.739 A 22.5,22.5 0 1 1 739.905,331.812"/>
    <text x="678.5" y="288.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="739.905,331.812 746.947,325.534 737.348,322.731"/>
    <polygon stroke="black" stroke-width="1" points="657.5,361.5 706.5,361.5"/>
    <polygon fill="black" stroke-width="1" points="706.5,361.5 698.5,356.5 698.5,366.5"/>
    <text x="676.5" y="352.5" font-family="Times New Roman" font-size="20">S</text>
    <polygon stroke="black" stroke-width="1" points="76.5,507.5 139.5,507.5"/>
    <polygon fill="black" stroke-width="1" points="139.5,507.5 131.5,502.5 131.5,512.5"/>
    <text x="102.5" y="498.5" font-family="Times New Roman" font-size="20">P</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 193.684,525.054 A 22.5,22.5 0 1 1 170.277,537.373"/>
    <text x="205.5" y="588.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="170.277,537.373 164.182,544.573 174.079,546.007"/>
    <polygon stroke="black" stroke-width="1" points="199.5,507.5 251.5,507.5"/>
    <polygon fill="black" stroke-width="1" points="251.5,507.5 243.5,502.5 243.5,512.5"/>
    <text x="219.5" y="498.5" font-family="Times New Roman" font-size="20">S</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 194.063,490.343 A 171.3,171.3 0 0 1 364.937,490.343"/>
    <polygon fill="black" stroke-width="1" points="364.937,490.343 360.497,482.019 355.51,490.686"/>
    <text x="272.5" y="458.5" font-family="Times New Roman" font-size="20">R</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 306.942,523.175 A 22.5,22.5 0 1 1 284.534,537.229"/>
    <text x="322.5" y="585.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="284.534,537.229 279.001,544.869 288.977,545.55"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 307.862,493.233 A 212.35,212.35 0 0 1 483.138,493.233"/>
    <polygon fill="black" stroke-width="1" points="483.138,493.233 477.915,485.377 473.788,494.486"/>
    <text x="388.5" y="465.5" font-family="Times New Roman" font-size="20">R</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 416.128,521.062 A 22.5,22.5 0 1 1 394.933,536.885"/>
    <text x="434.5" y="582.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="394.933,536.885 390.037,544.949 400.036,544.819"/>
    <polygon stroke="black" stroke-width="1" points="419.5,507.5 479.5,507.5"/>
    <polygon fill="black" stroke-width="1" points="479.5,507.5 471.5,502.5 471.5,512.5"/>
    <text x="443.5" y="498.5" font-family="Times New Roman" font-size="20">S</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 536.133,521.053 A 22.5,22.5 0 1 1 514.942,536.883"/>
    <text x="554.5" y="582.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="514.942,536.883 510.049,544.949 520.048,544.816"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 657.621,525.14 A 22.5,22.5 0 1 1 634.17,537.375"/>
    <text x="669.5" y="588.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="634.17,537.375 628.049,544.554 637.941,546.023"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 758.204,528.041 A 22.5,22.5 0 1 1 733.398,537.222"/>
    <text x="763.5" y="592.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="733.398,537.222 726.421,543.571 736.048,546.276"/>
    <polygon stroke="black" stroke-width="1" points="663.5,507.5 706.5,507.5"/>
    <polygon fill="black" stroke-width="1" points="706.5,507.5 698.5,502.5 698.5,512.5"/>
    <text x="679.5" y="498.5" font-family="Times New Roman" font-size="20">S</text>
</svg>
<p class="text-center"><small>Figure 3.5: The product of the bank&rsquo;s and the store&rsquo;s state machines; the reachable states are marked in green. <br />
P - <em>pay</em>, C - <em>cancel</em>, R - <em>redeem</em>, S - <em>ship</em>, T - <em>transfer</em>
</small></p></p>

<p>We&rsquo;ve drawn all of the state pairs and the transitions amongst them. We can now clearly see how the inputs affect the system as a whole. For instance, on <em>pay</em>, the store goes from <code>a</code> to <code>b</code>, whereas the bank stays put, therefore, <code>change_state((1,a), &quot;pay&quot;) -&gt; (1,b)</code>. From state <code>(1,b)</code>, on <em>redeem</em>, the store goes from state <code>b</code> to <code>d</code> and the bank from <code>1</code> to <code>3</code>, therefore, we end up in <code>change_state((1,b), &quot;redeem&quot;) -&gt; (3,d)</code>.</p>

<h3 id="eliminating-the-unreachable-states">Eliminating the Unreachable States</h3>

<p>We observe that not all states are reachable from the initial state <code>(1,a)</code>. For example, we cannot go to <code>(1,g)</code> where the store has shipped the goods after the money is transferred, but the bank is still waiting for a redeem - this makes no sense! We&rsquo;ve modeled our system such that a case like this cannot occur. We also found a flaw in our logic, that is, when the machine is in <code>(2,c)</code>, the items have been shipped but the money hasn&rsquo;t been transferred because the customer has issued <em>cancel</em>.</p>

<p><svg width="800" height="320" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <ellipse stroke="black" stroke-width="1" fill="none" cx="46.5" cy="91.5" rx="30" ry="30"/>
    <text x="32.5" y="97.5" font-family="Times New Roman" font-size="20">1, a</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="160.5" cy="91.5" rx="30" ry="30"/>
    <text x="145.5" y="97.5" font-family="Times New Roman" font-size="20">1, b</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="294.5" cy="91.5" rx="30" ry="30"/>
    <text x="280.5" y="97.5" font-family="Times New Roman" font-size="20">1, c</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="46.5" cy="229.5" rx="30" ry="30"/>
    <text x="32.5" y="235.5" font-family="Times New Roman" font-size="20">2, a</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="160.5" cy="229.5" rx="30" ry="30"/>
    <text x="145.5" y="235.5" font-family="Times New Roman" font-size="20">2, b</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="294.5" cy="229.5" rx="30" ry="30"/>
    <text x="280.5" y="235.5" font-family="Times New Roman" font-size="20">2, c</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="471.5" cy="229.5" rx="30" ry="30"/>
    <text x="456.5" y="235.5" font-family="Times New Roman" font-size="20">3, d</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="471.5" cy="91.5" rx="30" ry="30"/>
    <text x="457.5" y="97.5" font-family="Times New Roman" font-size="20">3, e</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="612.5" cy="229.5" rx="30" ry="30"/>
    <text x="599.5" y="235.5" font-family="Times New Roman" font-size="20">4, f</text>
    <ellipse stroke="black" stroke-width="1" fill="none" cx="612.5" cy="91.5" rx="30" ry="30"/>
    <text x="597.5" y="97.5" font-family="Times New Roman" font-size="20">4, g</text>
    <polygon stroke="black" stroke-width="1" points="187.922,103.668 444.078,217.332"/>
    <polygon fill="black" stroke-width="1" points="444.078,217.332 438.794,209.517 434.738,218.658"/>
    <text x="320.5" y="151.5" font-family="Times New Roman" font-size="20">R</text>
    <polygon stroke="black" stroke-width="1" points="76.5,91.5 130.5,91.5"/>
    <polygon fill="black" stroke-width="1" points="130.5,91.5 122.5,86.5 122.5,96.5"/>
    <text x="97.5" y="82.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon stroke="black" stroke-width="1" points="46.5,121.5 46.5,199.5"/>
    <polygon fill="black" stroke-width="1" points="46.5,199.5 51.5,191.5 41.5,191.5"/>
    <text x="28.5" y="166.5" font-family="Times New Roman" font-size="20">C</text>
    <polygon stroke="black" stroke-width="1" points="160.5,121.5 160.5,199.5"/>
    <polygon fill="black" stroke-width="1" points="160.5,199.5 165.5,191.5 155.5,191.5"/>
    <text x="142.5" y="166.5" font-family="Times New Roman" font-size="20">C</text>
    <polygon stroke="black" stroke-width="1" points="76.5,229.5 130.5,229.5"/>
    <polygon fill="black" stroke-width="1" points="130.5,229.5 122.5,224.5 122.5,234.5"/>
    <text x="97.5" y="220.5" font-family="Times New Roman" font-size="20">P</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 180.588,251.624 A 22.5,22.5 0 1 1 155.158,258.902"/>
    <text x="182.5" y="315.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="155.158,258.902 147.721,264.705 157.116,268.13"/>
    <polygon stroke="black" stroke-width="1" points="190.5,229.5 264.5,229.5"/>
    <polygon fill="black" stroke-width="1" points="264.5,229.5 256.5,224.5 256.5,234.5"/>
    <text x="221.5" y="220.5" font-family="Times New Roman" font-size="20">S</text>
    <polygon stroke="black" stroke-width="1" points="190.5,91.5 264.5,91.5"/>
    <polygon fill="black" stroke-width="1" points="264.5,91.5 256.5,86.5 256.5,96.5"/>
    <text x="221.5" y="82.5" font-family="Times New Roman" font-size="20">S</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 140.11,69.654 A 22.5,22.5 0 1 1 165.437,62.028"/>
    <text x="126.5" y="17.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="165.437,62.028 172.794,56.122 163.353,52.827"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 273.39,70.35 A 22.5,22.5 0 1 1 298.447,61.879"/>
    <text x="257.5" y="18.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="298.447,61.879 305.602,55.73 296.056,52.753"/>
    <polygon stroke="black" stroke-width="1" points="294.5,121.5 294.5,199.5"/>
    <polygon fill="black" stroke-width="1" points="294.5,199.5 299.5,191.5 289.5,191.5"/>
    <text x="276.5" y="166.5" font-family="Times New Roman" font-size="20">C</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 316.812,249.379 A 22.5,22.5 0 1 1 292.293,259.301"/>
    <text x="324.5" y="313.5" font-family="Times New Roman" font-size="20">P</text>
    <polygon fill="black" stroke-width="1" points="292.293,259.301 285.51,265.858 295.214,268.272"/>
    <polygon stroke="black" stroke-width="1" points="324.5,91.5 441.5,91.5"/>
    <polygon fill="black" stroke-width="1" points="441.5,91.5 433.5,86.5 433.5,96.5"/>
    <text x="376.5" y="112.5" font-family="Times New Roman" font-size="20">R</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 494.958,248.012 A 22.5,22.5 0 1 1 471.075,259.38"/>
    <text x="505.5" y="311.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="471.075,259.38 464.695,266.33 474.526,268.16"/>
    <polygon stroke="black" stroke-width="1" points="471.5,199.5 471.5,121.5"/>
    <polygon fill="black" stroke-width="1" points="471.5,121.5 466.5,129.5 476.5,129.5"/>
    <text x="455.5" y="166.5" font-family="Times New Roman" font-size="20">S</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 450.111,70.632 A 22.5,22.5 0 1 1 475.053,61.829"/>
    <text x="413.5" y="18.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="475.053,61.829 482.126,55.586 472.541,52.736"/>
    <polygon stroke="black" stroke-width="1" points="501.5,229.5 582.5,229.5"/>
    <polygon fill="black" stroke-width="1" points="582.5,229.5 574.5,224.5 574.5,234.5"/>
    <text x="535.5" y="220.5" font-family="Times New Roman" font-size="20">T</text>
    <polygon stroke="black" stroke-width="1" points="501.5,91.5 582.5,91.5"/>
    <polygon fill="black" stroke-width="1" points="582.5,91.5 574.5,86.5 574.5,96.5"/>
    <text x="535.5" y="82.5" font-family="Times New Roman" font-size="20">T</text>
    <path stroke="black" stroke-width="1" fill="none" d="M 640.687,219.577 A 22.5,22.5 0 1 1 637.521,245.838"/>
    <text x="686.5" y="244.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="637.521,245.838 639.982,254.945 646.786,247.616"/>
    <path stroke="black" stroke-width="1" fill="none" d="M 640.588,81.298 A 22.5,22.5 0 1 1 637.682,107.588"/>
    <text x="686.5" y="105.5" font-family="Times New Roman" font-size="20">P, C</text>
    <polygon fill="black" stroke-width="1" points="637.682,107.588 640.233,116.671 646.964,109.275"/>
    <polygon stroke="black" stroke-width="1" points="612.5,199.5 612.5,121.5"/>
    <polygon fill="black" stroke-width="1" points="612.5,121.5 607.5,129.5 617.5,129.5"/>
    <text x="596.5" y="166.5" font-family="Times New Roman" font-size="20">S</text>
</svg>
<p class="text-center"><small>Figure 3.6: The combined state machine for the bank and the store.
<br />
P - <em>pay</em>, C - <em>cancel</em>, R - <em>redeem</em>, S - <em>ship</em>, T - <em>transfer</em></small>
</p></p>

<p>After discarding the unreachable states and all of their outgoing transitions, we end up with a much clearer picture, that is, a state machine that is easy to understand yet encodes complex business logic.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we&rsquo;ve informally introduced the concept of finite state machines and a new way to implement them in C# using pattern matching. We examined a scenario with multiple participants whose behavior we can model as state machines. We learned how to combine those state machines and establish a unified workflow. This made it much easier to reason about the soundness of our system and depict its possible use cases.</p>

<p>State machines present a powerful way to express application logic. That way, seemingly complex set business rules can be reduced to something easy to comprehend, extend and modify.
They are no silver bullet though. Not every domain is suitable to be modeled in such a way. When we have to deal with a system which oftentimes involves human interaction and its events do not always occur in a prescribed order, state machines are a powerful tool in our toolbox - well worth exploring.</p>

<h2 id="references-and-further-reading">References and Further Reading</h2>

<ul>
<li><em>&ldquo;Introduction To Automata Theory Languages, and Computation&rdquo;</em> Hopcroft, Ullmann, Motwani; Chapter 2 - Finite Automata</li>
<li><a href="https://devblogs.microsoft.com/dotnet/do-more-with-patterns-in-c-8-0/">Do more with patterns in C# 8.0</a></li>
<li><a href="https://css-tricks.com/robust-react-user-interfaces-with-finite-state-machines/">Robust React User Interfaces with Finite State Machines</a></li>
<li><a href="http://madebyevan.com/fsm/">Finite State Machine Desigher</a></li>
<li><a href="https://github.com/dotnet-state-machine/stateless">stateless</a> - a state machine library for .NET</li>
<li><a href="https://github.com/danielgerlag/workflow-core">workflow-core</a> - a .NET workflow engine</li>
</ul>


		<section class="social-share">
    
    
    <a href="//twitter.com/share?url=https%3a%2f%2fdeniskyashif.com%2fa-practical-guide-to-state-machines%2f&amp;text=A%20Practical%20Guide%20to%20%20State%20Machines&amp;via=deniskyashif" target="_blank" class="share-btn twitter">
        <i class="fa fa-2x fa-twitter"></i>
    </a>
    
    
    
    <a href="//reddit.com/submit?url=https%3a%2f%2fdeniskyashif.com%2fa-practical-guide-to-state-machines%2f&amp;title=A%20Practical%20Guide%20to%20%20State%20Machines" target="_blank" class="share-btn reddit">
        <i class="fa fa-2x fa-reddit-alien"></i>
    </a>
    
    
    
    <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fdeniskyashif.com%2fa-practical-guide-to-state-machines%2f" target="_blank" class="share-btn facebook">
        <i class="fa fa-2x fa-facebook"></i>
    </a>
    
    
    
    <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fdeniskyashif.com%2fa-practical-guide-to-state-machines%2f&amp;title=A%20Practical%20Guide%20to%20%20State%20Machines" target="_blank" class="share-btn linkedin">
        <i class="fa fa-2x fa-linkedin"></i>
    </a>
    
    
    
    
    
    <a href="mailto:?subject=Check out 'A%20Practical%20Guide%20to%20%20State%20Machines' by Denis%20Kyashif&amp;body=https%3a%2f%2fdeniskyashif.com%2fa-practical-guide-to-state-machines%2f" target="_blank" class="share-btn email">
        <i class="fa fa-2x fa-envelope"></i>
    </a>
    
</section>

<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "deniskyashif" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




	</div>

	<div class="pagination">
		<a href="/translation-using-syntactic-rules/" class="left arrow">&#8592;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        <footer>
	<span>
		&copy; <time datetime="2019-11-20 07:35:06.56676 &#43;0200 EET m=&#43;0.163369636">2019</time> Denis Kyashif
	</span>
    <br/>
</footer>

    </body>
</html>
